@{
    Layout = "~/Areas/AppPage/Views/Shared/_Layout.cshtml";
}
<!--Switchery [ OPTIONAL ]-->
<link href="~/Assets/plugins/switchery/switchery.min.css" rel="stylesheet">
 <!--Bootstrap Select [ OPTIONAL ]-->
<link href="~/Assets/plugins/bootstrap-select/bootstrap-select.min.css" rel="stylesheet">
  <!--Chosen [ OPTIONAL ]-->
<link href="~/Assets/plugins/chosen/chosen.min.css" rel="stylesheet">



<div id="page-content">


    <div class="row">
        <div class="col-lg-12">


            <div class="tab-base">

                <!--Nav Tabs-->
                <ul class="nav nav-tabs">
                    <li class="active">
                        <a data-toggle="tab" href="#demo-lft-tab-1" aria-expanded="true" id="tab_preaprobados">Dotación</a>
                    </li>
                    
                </ul>

                <!--Tabs Content-->
                <div class="tab-content">
                    <div id="demo-lft-tab-1" class="tab-pane fade active in">
                        <div class="panel-body">
                            <form id="form-asignados" action="#" method="get">

                                <div class="filtros col-lg-12">

                                    <div class="form-group col-lg-1">
                                        <label class="control-label">Sel. Todos</label>
                                        <div class="">
                                            <input class="js-switch" type="checkbox" id="cbSelTodos" checked />
                                        </div>
                                    </div>


                                    <div class="form-group col-lg-2">
                                        <label class="control-label">Periodo</label>
                                        <div class="">
                                            <select class="form-control" id="slPeriodo" name="periodo">
                                                <option value="201705">Mayo 2017</option>

                                            </select>
                                        </div>
                                    </div>


                                    <div class="form-group col-lg-3">
                                        <label class="control-label">Cargo</label>
                                        <div class="">
                                            <select class="form-control" id="slCargo">
                                                <option value="0">Todos</option>
                                                <option value="1">Gerente General</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="form-group col-lg-1 col-lg-offset-1">
                                        <label class="control-label">&nbsp;</label>
                                        <div class="">
                                            <button class="btn btn-primary" id="btn-guardar">Guardar</button>
                                            
                                        </div>

                                    </div>

                                </div>




                                <table class="table table-hover table-vcenter">
                                    <thead>
                                        <tr>
                                            <th class="min-width">Asignar</th>
                                            <th style="width:30%;">Ejecutivo</th>
                                            <th>Cargo</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ejecutivos-oficina"></tbody>
                                </table>


                                <input type="hidden" name="oficina" id="oficina" />
                            </form>

                        </div>
                    </div>
                    

                </div>
            </div>
        </div>

    </div>



</div>


@section script{ 

    <!--Switchery [ OPTIONAL ]-->
<script src="~/Assets/plugins/switchery/switchery.min.js"></script>
    <!--Bootstrap Select [ OPTIONAL ]-->
<script src="~/Assets/plugins/bootstrap-select/bootstrap-select.min.js"></script>
<!--Chosen [ OPTIONAL ]-->
<script src="~/Assets/plugins/chosen/chosen.jquery.min.js"></script>


    <script>
        $(document).ready(function () {

            
            $("#oficina").val(getCookie("Oficina"))



            $("#slPeriodo").on("change", function () {
                $.SecGetJSON(BASE_URL + "/motor/api/Gestion/listar-mi-oficina-historica", { tipoCampania: 0, periodo: $("#slPeriodo").val() }, function (respuesta) {

                    $("#slCargo").html("");
                    $("#slCargo").append($("<option>").prop({ "value": ""}).html("Seleccione"))
                    $("#ejecutivos-oficina").html("");
                    $.each(respuesta, function (i, e) {


                        $("#ejecutivos-oficina").append(
                            $("<tr>")
                            .append(
                                $("<td>").addClass("text-center")
                                         .append(
                                               $("<input>").prop({ "type": "checkbox", "value": e.EjecutivoData.Rut, "checked": (e.EjecutivoData.EsAsignable === 1) ? "checked" : "", "name":"ejecutivos" }).addClass("habilitado")
                                          )
                            ).append(
                                $("<td>").append(
                                    $("<span>").addClass("text-main").addClass("text-semibold").html(e.EjecutivoData.Nombres)
                                ).append($("<br>"))
                                .append(
                                    $("<small>").addClass("text-muted").html(e.EjecutivoData.Rut)
                                )
                            ).append(
                                $("<td>").append(
                                    $("<span>").addClass("text-main").addClass("text-semibold").html(e.EjecutivoData.Cargo)
                                ).addClass("busqueda-cargo")
                            )
                        );

                       

                        var valuesArray = $("#slCargo option").map(function () {
                            return this.value;
                        }).get();

                        
                        if ($.inArray(e.EjecutivoData.Cargo, valuesArray) === -1)
                        {
                            $("#slCargo").append($("<option>").prop({ "value": e.EjecutivoData.Cargo }).html(e.EjecutivoData.Cargo))
                        }
                        

                    });


                    var elems = Array.prototype.slice.call(document.querySelectorAll('.habilitado'));
                    elems.forEach(function (html) {
                        var switchery = new Switchery(html);
                    });
                });

                $.SecGetJSON(BASE_URL + "/motor/api/Config/proceso-dotacion-abierto", { periodo: $("#slPeriodo").val() }, function (datos) {
                    if (datos.Objeto === 0)
                    {
                        $("#btn-guardar").text("Proceso Cerrado").prop({ "disabled": "disabled" }).removeClass("btn-primary").addClass("btn-warning");
                    }
                    else
                    {
                        $("#btn-guardar").text("Guardar").prop({ "disabled": "" }).removeClass("btn-warning").addClass("btn-primary");
                    }
                });

            })

            $.SecGetJSON(BASE_URL + "/motor/api/Gestion/listar-periodosDotacion", { tipoAsignacion: 1 }, function (datos) {

                $("#slPeriodo").html("");
                $.each(datos, function (i, periodo) {

                    if (periodo.Periodo >= 201707)
                    {
                        $("#slPeriodo").append($("<option>").val(periodo.Periodo).html(periodo.PeriodoText));
                    }
                });

                $("#slPeriodo").trigger("change");
            });


            $("#cbSelTodos").on("change", function (e) {
                if ($(this).is(":checked")) {
                    $("input:checkbox.habilitado:not(:checked)").trigger("click");
                } else {
                    $("input:checkbox.habilitado:checked").trigger("click");
                }
            });


            $("#slCargo").on("change", function (e) {
                
                $("#ejecutivos-oficina").find("tr").show();
                //$("input:checkbox.habilitado:not(:checked)").trigger("click");
                if ($(this).val() != "")
                {
                    var t = $(this);
                    $.each($("td.busqueda-cargo"), function (i, e) {
                        if($(t).val() !== $(e).find("span").html())
                        {
                            //$(e).closest("tr").find("td > input.habilitado:checked").trigger("click");
                            $(e).closest("tr").hide();
                        }
                    });
                }
            });


            $("#form-asignados").on("submit", function () {

                $.SecPostJSON(BASE_URL + "/motor/api/Config/guarda-dotacion", $("#form-asignados").serialize(), function (datos) {
                    $.niftyNoty({
                        type: 'success',
                        icon: 'pli-like-2 icon-2x',
                        message: 'Dotacion Actualizada...',
                        container: 'floating',
                        timer: 5000
                    });
                });

                return false;
            })



            
            var elems = Array.prototype.slice.call(document.querySelectorAll('.js-switch'));
            elems.forEach(function (html) {
                var switchery = new Switchery(html);
            });



        });
        

    </script>

}